<!DOCTYPE html>

<html>

  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <head>

      <?!= extraer_archivo('cliente_logico.js'); ?>
      <?!= extraer_archivo('cliente_interfaz.css'); ?>

  </head>
  <body>
  
  <div class="sidebar branding-below">
    <div class="separador_logo">
        <div id="imagen_logo">
        <img src="https://raw.githubusercontent.com/Espejin/ADD-ON-GAS-PUBLIC/main/add_on_logo_2.PNG" class="logo_addon">
        </div>
        <div id="texto_logo">
          <span> ADD-ON </span> 
          <span> Interpretación </span>
          <span> Gráfica </span>
        </div>
    </div>
    
    <div>
        <span class="titulo_separador" style="color:gray">Parámetros rellenables:</span> 
        <div class="separador_secciones">

            <div class="separador_elemento_izq" style="left: 20px;">
                <label class="custom-field">
                <input type="text" placeholder="&nbsp;" id="tiempo"/>
                <span class="placeholder">Tiempo:</span>  
                </label>
            </div>

            <div class="separador_elemento_der">
                <label class="custom-field">
                <input type="text" placeholder="&nbsp;" id="rango"/>
                <span class="placeholder">Rango:</span>  
                </label>
            </div>

        </div>
    


    <span class="titulo_separador_selects" style="color:gray">Parámetros seleccionables:</span>

    <div class="separador_secciones_selects">
  
    <div class="separador_elemento_unico">
        <label for="Tipo_Grafico"><font size = 2 >Selector de Gráfico:</font></label>
        <select id="Tipo_Grafico" style="width: 100%;">
          <option value="G1" selected>Gráfico de Linea</option>
          <option value="G2">Gráfico de Barras</option>
          <option value="G3">Gráfico de Pastel</option>
          <option value="G4">Gráfico de Dispersión</option>
        </select>
    </div>

    <div class="separador_elemento_unico">
        <label for="Timbre"><font size = 2 >Selector de Timbre:</font></label>
        <select id="Timbre" style="width: 100%;">
          <option value="T1" selected>Timbre 1 (Única Señal)</option>
          <option value="T2">Timbre 2 (2 Señales)</option>
          <option value="T3">Timbre 3 (3 Señales)</option>
          <option value="T4">Timbre 4 (4 Señales)</option>
        </select>
    </div>

    <div class="separador_elemento_unico_final">
        <label for="Vacios"><font size = 2 >Faltantes y Especiales:</font></label>
        <select id="Vacios" style="width: 100%;">
          <option value="O1" selected> Suavizar </option>
          <option value="O2">Rellenar con promedio de la columna</option>
        </select>
    </div>
    </div>

    <span class="titulo_separador_selects header_correo" style="color:gray">Compartir documento (Opcional):</span>
    <div class="separador_secciones especial_correo">
        <div class="alinea_correo separador_elemento_izq" style="left: 20px;">
            <label class="custom-field">
            <input type="email" placeholder="&nbsp;" id="correo" style="width:240px;margin-bottom:2px;"/>
            <span class="placeholder">Correo:</span>  
            </label>
        </div>

        <div class="separador_elemento_der">
            <input type="button" id="btn_correo" value="Compartir" onclick="compartir_correo()" />
        </div>
    </div>

    <div class="separador_botones">
      <input type="button" class="share" id="reproducir" value="Sonificación!"
      onclick="probando_gs()" />
      <input type="button" class="action" id="detener" value="Detener"
      onclick="detener_audio()" />
    </div>
    
    <div class="btn_tutorial">
    <a class="href_text" id="tutorial" href="https://espejin.github.io/ADD-ON-GAS-PUBLIC/" target="_blank">?</a>
    </div>


    <span class="pie_pagina" style="color:#D0D0D0">
      Desarrollado por Bryan Torres - 2021
    </span>


  </div>

  <script>
    
        //------------------------------------------------------------------------------------------------------
        //Se coloca el zoom de manera predeterminada para preservar la relacion de aspecto
        document.body.style.zoom="79%";

        //------------------------------------------------------------------------------------------------------
        //Variables del generador de voz, text-to-speach:
        var synthesis = window.speechSynthesis;
        var voices = synthesis.getVoices();
        var utterance = new SpeechSynthesisUtterance();
        utterance.lang = 'es-ES';
        utterance.voice = voices[1];

        //------------------------------------------------------------------------------------------------------
        //Sonidos de retroalimentacion positiva y negativa:
        var audio_error = new Audio('https://github.com/Espejin/ADD-ON-GAS-PUBLIC/blob/main/Efecto_Sonido/Sonido_Error.mp3?raw=true');
        var audio_correcto = new Audio('https://github.com/Espejin/ADD-ON-GAS-PUBLIC/blob/main/Efecto_Sonido/Sonido_Correcto.mp3?raw=true');

        //------------------------------------------------------------------------------------------------------
        //PROGRAMACION DE ACCESOS RAPIDOS POR TECLADO:
        //------------------------------------------------------------------------------------------------------

        //------------------------------------------------------------------------------------------------------
        //Variables auxiliares
        var flujo = 0;
        var flujo_aux = 0;
        var aux_graf_evento = 0;
        var aux_relleno_evento = 0;
        var comprobando_celdas = 0;
        var comprobando_correo = 0;
        
        //------------------------------------------------------------------------------------------------------
        //Se configura un evento relacionado a presionar cualquier tecla del teclado
        window.addEventListener('keydown', function (event) {
        var mensaje = "";
        var tiempo = 0;
     
        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la combinacion de SHIFT + F
        if(event.shiftKey && event.code === 'KeyF'){
            console.log("Presionado SHIFT + F");
            //Grafico de Linea

            if(aux_graf_evento === 4){
                aux_graf_evento = 0;
            }

            if(flujo_aux == 3){

                if(aux_graf_evento === 0){
                    document.getElementById("Tipo_Grafico").selectedIndex = aux_graf_evento; 
                    mensaje = "Usted ha seleccionado el gráfico de línea.";
                    text_speach(mensaje);
                    aux_graf_evento = 1;
                }
                else if(aux_graf_evento === 1){
                    document.getElementById("Tipo_Grafico").selectedIndex = aux_graf_evento; 
                    mensaje = "Usted ha seleccionado el gráfico de barras.";
                    text_speach(mensaje);
                    aux_graf_evento = 2;  
                }
                else if(aux_graf_evento === 2){
                    document.getElementById("Tipo_Grafico").selectedIndex = aux_graf_evento; 
                    mensaje = "Usted ha seleccionado el gráfico de pastel.";
                    text_speach(mensaje);
                    aux_graf_evento = 3;  
                }
                else if(aux_graf_evento === 3){
                    document.getElementById("Tipo_Grafico").selectedIndex = aux_graf_evento; 
                    mensaje = "Usted ha seleccionado el gráfico de dispersión.";
                    text_speach(mensaje);
                    aux_graf_evento = 4;  
                }
                flujo = 4;
            }
            else if(flujo_aux == 4){

                if(aux_graf_evento === 0){
                    document.getElementById("Timbre").selectedIndex = aux_graf_evento;
                    mensaje = "Usted ha seleccionado el Timbre 1, timbre con una señal."
                    text_speach(mensaje); 
                    aux_graf_evento = 1;
                }
                else if(aux_graf_evento === 1){
                    document.getElementById("Timbre").selectedIndex = aux_graf_evento;
                    mensaje = "Usted ha seleccionado el Timbre 2, timbre con una señal y un armónico."
                    text_speach(mensaje); 
                    aux_graf_evento = 2;  
                }
                else if(aux_graf_evento === 2){
                    document.getElementById("Timbre").selectedIndex = aux_graf_evento; 
                    mensaje = "Usted ha seleccionado el Timbre 3, timbre con una señal y dos armónicos."
                    text_speach(mensaje);
                    aux_graf_evento = 3;  
                }
                else if(aux_graf_evento === 3){
                    document.getElementById("Timbre").selectedIndex = aux_graf_evento; 
                    mensaje = "Usted ha seleccionado el Timbre 4, timbre con una señal y tres armónicos."
                    text_speach(mensaje);
                    aux_graf_evento = 4;  
                }
                flujo = 5;
            }

            else if(flujo_aux == 5){

                if(aux_graf_evento === 0){
                    document.getElementById("Vacios").selectedIndex = aux_graf_evento;
                    mensaje = "Usted ha seleccionado ignorar los valores vacíos o caracteres especiales."
                    text_speach(mensaje); 
                    aux_graf_evento = 1;
                }
                else if(aux_graf_evento === 1){
                    document.getElementById("Vacios").selectedIndex = aux_graf_evento;
                    mensaje = "Usted ha seleccionado reemplazar los valores vacíos o caracteres especiales por el promedio de su agrupación."
                    text_speach(mensaje); 
                    aux_graf_evento = 4;  
                }
                flujo = 6;
            }    

        }

        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la combinacion de SHIFT + G
        if(event.shiftKey && event.code === 'KeyG'){

            if(flujo === 7){
                flujo = 2;
            }

            tiempo = 0; 
            tiempo = 200;
            setTimeout(text_speach,tiempo,"Puedes presionar ALT + G en cualquier momento para detener los efectos de sonido");
            setTimeout(text_speach,tiempo+4000,"Presiona las teclas ALT más P, para ingresar el rango del gráfico.");
            flujo = 2;

        }

        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la tecla ENTER
        if(event.keyCode === 13){
            
            if(flujo == 3 && (typeof parseFloat(document.getElementById("tiempo").value) != 'number' || parseFloat(document.getElementById("tiempo").value) < 0)){
              document.getElementById("tiempo").value = "";
              text_speach("Tiempo incorrecto, porfavor ingresa nuevamente el tiempo como número y en segundos:")
            }

            else{


              if(flujo == 2.5){
                
                  let prueba = google.script.run.withSuccessHandler(

                  function (fuente) 
           { 
                  let prueba =  JSON.parse(fuente);  // undefined
                  if(prueba === "ERROR_SELECT"){
                      setTimeout(text_speach,200,"No se ha escrito rango o seleccionado mediante cursor o teclado. Intente nuevamente por favor o presione ALT + P para escribir un rango.");
                      document.getElementById("rango").value = "";
                      comprobando_celdas = 0;
                  }
                  else if(prueba === "ERROR_INSERT"){
                      setTimeout(text_speach,200,"El rango de celdas ingresado no es correcto, presione ALT + P para ingresar nuevamente o seleccione mediante teclado o cursor por favor.");
                      document.getElementById("rango").value = "";
                      comprobando_celdas = 0;
                  }
                  else if(prueba === "CORRECTO"){
                      comprobando_celdas = 1;
                      setTimeout(text_speach,200,"Presiona ALT + P  para ingresar el tiempo de sonificación.");
                  } 

                  if(comprobando_celdas !=0){
                    document.activeElement.blur();
                    aux_relleno_evento = 1;
                    flujo = 2.5;
                  }
                  else{
                    document.getElementById("rango").focus();
                    aux_relleno_evento = 0;
                    flujo = 2.5;
                  }

            }
            ).verificar_rango(document.getElementById("rango").value);

          
            }

              if(flujo == 3){

                document.activeElement.blur();
                text_speach("Presiona las teclas shift más F para seleccionar el tipo de gráfico, tras finalizar decisión presiona ENTER");
                aux_relleno_evento = 0;
                aux_graf_evento = 0;
                flujo_aux = 3;
            }


            if(flujo == 4){
                text_speach("Presiona las teclas shift más F para seleccionar el tipo de timbre, tras finalizar decisión presiona ENTER ");
                flujo_aux = 4;
                aux_graf_evento = 0;
            }

            if(flujo == 5){
                text_speach("Presiona las teclas shift más F para seleccionar el método de manejo de valores faltantes.");
                aux_graf_evento = 0;
                flujo_aux = 5;
            }

            if(flujo == 6){
                aux_graf_evento = 0;
                text_speach("Presiona las teclas shift más J para sonificar el gráfico seleccionado.");
                flujo_aux = 6;
            }

            if(flujo == 7){

                let prueba = google.script.run.withSuccessHandler(

                  function (fuente) 
           { 
                  let prueba =  JSON.parse(fuente);  // undefined
                  if(prueba === "ERROR"){
                      setTimeout(text_speach,200,"Error al enviar correo, porfavor presione ALT + P para ingresar nuevamente el correo.");
                      comprobando_celdas = 0;
                      document.getElementById("correo").value = "";
                  }
                  else if(prueba === "CORRECTO"){
                      comprobando_celdas = 1;
                      //console.log("Valor adentro : " + comprobando);
                      setTimeout(text_speach,200,"Documento compartido satisfactoriamente, presione SHIFT + G para sonificar otro gráfico o ALT + J para escuchar la última sonificación, o SHIFT + H para compartir con otra persona");
                  } 

                  if(comprobando_celdas !=0){
                    document.activeElement.blur();
                    aux_relleno_evento = 0;
                    flujo = 7;
                  }
                  else{
                    document.getElementById("correo").focus();
                    aux_relleno_evento = 2;
                    flujo = 7;
                  }

            }
            ).compartir_archivo(document.getElementById("correo").value);

                aux_graf_evento = 0;
                flujo_aux = 6;
            }

            }
            
        }

        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la combinacion de ALT + P

        if(event.altKey && event.code === 'KeyP'){
            tiempo = 0;
            //Grafico de Linea

            if(aux_relleno_evento === 0 && flujo === 2){
                document.getElementById("rango").focus();
                mensaje = "Ingrese el rango de celdas para la extracción de datos en notación A1 o seleccionelo en la hoja de cálculo mediante cursor o teclado."
                flujo = 2.5;
                text_speach(mensaje);
            }
            else if(aux_relleno_evento == 1 && flujo === 2.5){
                document.getElementById("tiempo").focus();
                mensaje = "Ingrese el tiempo deseado en segundos y posteriormente la tecla ENTER"
                text_speach(mensaje);
                tiempo = tiempo_speach(mensaje)*1000 + 200;
                flujo = 3;
            }
            else if(aux_relleno_evento == 2 && flujo === 7){
                document.getElementById("correo").focus();
                mensaje = "Ingrese el correo: "
                text_speach(mensaje);
                tiempo = tiempo_speach(mensaje)*1000 + 200;
                flujo = 7;
            }
        }


        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la combinacion de SHIFT + J

        if(event.shiftKey && event.code === 'KeyJ'){
          
            if(flujo != 6){
                text_speach("No se puede sonificar sin ingresar correctamente los parámetros");
            }
            else{
                probando_gs();
                flujo = 7;
            }
        
            //setTimeout(text_speach,tiempo,"Presiona las teclas ALT más P, para ingresar el tiempo del gráfico")
        }

        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la combinacion de SHIFT + H

        if(event.shiftKey && event.code === 'KeyH'){

          if(flujo === 7){
              text_speach("Presione las teclas ALT + P para escribir el correo de la persona con quien desee compartir el documento.")
              aux_relleno_evento = 2;
          }

        }

        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la combinacion de SHIFT + J

        if(event.altKey && event.code === 'KeyJ'){

          if(flujo === 7){
              probando_gs();
              flujo = 7;
          }

        }

        //------------------------------------------------------------------------------------------------------
        //Se asigna funcionalidad a la combinacion de ALT + G

        if(event.altKey && event.code === 'KeyG'){

            detener_audio();

        }

        //Probar funciones
        if(event.shiftKey && event.code === 'KeyQ'){

            google.script.run.imprimir_datos();

        }


        });

        //------------------------------------------------------------------------------------------------------
        // -- FUNCIONALIDAD QUE DETECTA SI EL USUARIO SE ENCUENTRA SOBRE EL ADD ON
        //------------------------------------------------------------------------------------------------------

        // Detectar presencia del usuario sobre el ADD-ON:
          var detecta_presencia = 0;
          var presencia_inicial = 0;

          //Se crea un evento asociado a si el raton abandona un elemento
          window.addEventListener('mouseout', function(evt) {

          //Si se sale del add-on suna la retroalimentacion negativa
          if (evt.toElement === null && evt.relatedTarget === null && detecta_presencia === 1 && presencia_inicial === 1) {
              detecta_presencia = 0;
              reproducir_efecto_sonido("error");

          }
          
          //Si se sale del add-on suna la retroalimentacion positiva
          if (evt.toElement != null && evt.relatedTarget != null && detecta_presencia === 0 && presencia_inicial === 1) {
              detecta_presencia = 1;
              reproducir_efecto_sonido("correcto");

          }

          });

        //------------------------------------------------------------------------------------------------------
        //A ejecutar en cuanto cargue el ADD-ON:
        window.addEventListener("load", function(){
            if(flujo == 0){
                var t_presentacion = 0;


                //Se da una bienveniad al usuario mediante sintesis de voz
                var bienvenida = google.script.run.withSuccessHandler(

                function (fuente) 
                { 
                    let nombre_usuario = JSON.parse(fuente);
                    
                    let presentacion = "Buen día " + nombre_usuario +  " te damos la bienvenida al ADD-ON de interpretación gráfica";
                    text_speach(presentacion);
                    t_presentacion = (2000*2) + 50;

                    let mensaje2 = "Para comenzar, deberás mover el cursor hacia la derecha hasta escuchar el siguiente sonido: ";
                    let mensaje3 = "Posteriormente, presione SHIFT + G para comenzar la sonificación"
                    setTimeout(text_speach,t_presentacion,mensaje2);
                    setTimeout(reproducir_efecto_sonido,(t_presentacion + 7000),"correcto");
                    setTimeout(text_speach,(t_presentacion + 6200),mensaje3);

                    t_presentacion = t_presentacion + 6200;

                    setTimeout(cambiar_presencia_inicial,t_presentacion)
              
                }).devolver_Nombre();
              
                flujo = 2;
            
            }
        });

        //Cambia el estado de la presencia sobre el add-on
        function cambiar_presencia_inicial(){
            presencia_inicial = 1;
        }

        //Funcion para cambiar la presencia sobre el add-on
        function cambiar_presencia_regular(tipo_pre){

            if ( tipo_pre === 0 ){
                detecta_presencia = 1;
            }
            else{
                detecta_presencia = 0;
            }

        }
        
        //------------------------------------------------------------------------------------------------------
        //Funcion que permite realizar una descripcion hablada mediante sintesis por voz, con controles
        //de desbordamiento
        function text_speach(mensaje){

            if(finaliza_sonificacion === 1 && document.getElementById("Tipo_Grafico").value == "G2"){
             
                clearTimeout(tiempo_grafico);
                clearTimeout(tiempo_grafico_speach);
                clearTimeout(tiempo_grafico_speach_aux);

                return;

            } else if(finaliza_sonificacion === 1 && document.getElementById("Tipo_Grafico").value != "G2"){

                clearTimeout(tiempo_grafico);
                clearTimeout(tiempo_grafico_speach);
                return;

            } else if(finaliza_sonificacion != 1){

                utterance.text = mensaje;
                synthesis.speak(utterance);

            }

        }

        //------------------------------------------------------------------------------------------------
        //Variables auxiliares de finalizacion del add-on
        var finaliza_sonificacion ;
        var sonificacion_curso;


        //Funcion que permite detener una sonificacion o un evento de sintesis por voz
        function detener_audio(){

            //console.log("Entra a detener")
            if(sonificacion_curso === 0){
                synthesis.cancel();
            }
            else{
                synthesis.cancel();
                detener_sonficacion();
                finaliza_sonificacion = 1;
                
                setTimeout(text_speach,500,"Sonificación Finalizada forzosamente. Presiona las teclas SHIFT + G para realizar una nueva sonificación, las teclas ALT + J para escuchar nuevamente la última sonificación o las teclas SHIFT + H para compartir el documento con un amigo.");
                 
            }

        }
        

        //Calcula el tiempo aproximado que tardara en reproducrise un mensaje de sintesis por voz
        function tiempo_speach(mensaje){
            //Speak Rate 1 por defecto, correspondiente a 150 a 220 palabras por minuto [wpm] 
            let wps = 100 / 60;
            return mensaje.split(" ").length/wps;
        }

        //Permite reproducir uno de las dos retroalimentaciones auditivas
        function reproducir_efecto_sonido(tipo){
            
            let efecto_sonido;

            if(tipo === "error"){
                efecto_sonido = audio_error
                efecto_sonido.volume = 0.4;
                efecto_sonido.play();
            }
            else{
                efecto_sonido = audio_correcto;
                efecto_sonido.volume = 0.4;
                efecto_sonido.play();
            }

        }

  </script>

  </body>
</html>
