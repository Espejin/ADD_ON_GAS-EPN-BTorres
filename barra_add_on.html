<!DOCTYPE html>

<html>
  <script type="text/javascript" src="https://raw.githubusercontent.com/GTCMT/DataToMusicAPI/master/dtm.js"></script>
  <head>
  </head>
  <body>
    <p>Prueba de interfaz: </p>
    <label> Tiempo: </label> <input type="text" id="tiempo">  
    <!--
    <p> <button type="button" onclick="google.script.run.bienvenida()">Comenzar</button> </p>
    -->
    <br>
    <p>Selector de Timbre: </p>
    <select id="Timbre">
    <option value="T1" selected>Timbre 1 (Única Señal)</option>
    <option value="T2">Timbre 2 (2 Señales)</option>
    <option value="T3">Timbre 3 (3 Señales)</option>
    <option value="T4">Timbre 4 (4 Señales)</option>
    </select>
    <br>
    <p>Manejo de  valores faltantes y caracteres especiales: </p>
    <select id="Vacios">
    <option value="O1" selected> Suavizar </option>
    <option value="O2">Rellenar con promedio de la columna</option>
    </select>
    <!--
    <input type="radio" id="uno" value="uno" name="timbre">Timbre con una señal<br>   
    <input type="radio" id="dos" value="dos" name="timbre">Timbre mezclando dos señales<br>   
    <input type="radio" id="tres" value="tres" name="timbre">Timbre mezclando tres señales<br>  
    <input type="radio" id="cuatro" value="cuatro" name="timbre">Timbre mezclando cuatro señales<br><br> 
    -->
    <p> <input type="button" value="Comienza Sonificación!"
      onclick="probando_gs()" /> </p>
      
    <hr>
    <p>Selector de Gráfico: </p>
    <select id="Tipo_Grafico">
    <option value="G1" selected>Gráfico de Linea</option>
    <option value="G2">Gráfico de Barras</option>
    <option value="G3">Gráfico de Pastel</option>
    <option value="G4">Gráfico de Dispersión</option>
    </select>

    <!--
    <p>Tratamiento de vacíos o caracteres especiales</p>
    <label> Opcion: </label> <input type="text" id="vacios">  -->
    
    <!--<p> <button type="button" id="detener">Detener Sonido</button> </p> -->
    <p> <button type="button" onclick="google.script.run.graficador(document.getElementById('Tipo_Grafico').value)">Graficador</button> </p>
    <hr>
    <label> texto: </label> <input type="text" id="tts">  
    <p> <button type="button" onclick="text_speach()">Probando texto a voz: </button> </p>
    <p> <button type="button" onclick="google.script.run.escalador_frecuencias_barras(3,'O1')">Probador de funciones: </button> </p>
    
    <!--
    <p> <button type="button" onclick="prueba_dtm()">Prueba funciones programación</button> </p>
    <p> <button type="button" onclick="google.script.run.entregador(10)">Prueba integración</button> </p>
    -->
    
    <script>

        //Variables del generador de voz, text-to-speach:
        var synthesis = window.speechSynthesis;
        var voices = synthesis.getVoices();
        var utterance = new SpeechSynthesisUtterance();
        utterance.lang = 'es-ES';
        utterance.voice = voices[1];
        //


        function probando_gs(){
        
        var tiempo = parseFloat(document.getElementById("tiempo").value);
        var vacio = document.getElementById("Vacios").value;
        var tipo_g = document.getElementById("Tipo_Grafico").value;

        var dato = google.script.run.withSuccessHandler(

          function (fuente) 
           { 
             var datazo =  JSON.parse(fuente);  // undefined
             const frecuencias_f = datazo[0];
             const tiempo_f = datazo[1];
             const espacio_f = datazo[2];

             console.log(frecuencias_f); // Escalamiento de Frecuencias
             //ejecutador_graficos(frecuencias_f,tiempo_f,espacio_f,frecuencias_f.length);
             console.log(tiempo_f);  // Escalamiento de tiempo
             console.log(espacio_f);  //Eje espacial
           }
        ).colocador_datos(tiempo,vacio,tipo_g);
          
          //var datos_a = google.script.run.withSuccessHandler(pasoporServer).probador();
          //console.log(dato);
        }

        function ejecutador_graficos(vec_frecuencia,vec_tiempo,vec_canal,ejecuciones){

          //console.log(vec_frecuencia[0]);
          //console.log(vec_tiempo[0]);
          //console.log(ejecuciones);
          
          let count = 1;
          let tiempo_espera = 0;
          let tiempo_tts = 0;
          let texto = "";
          let duracion_speach = 0;

          var detener = document.getElementById("detener");

          for(var i = 0; i < ejecuciones; i++){

              
              texto = "Gráfico número " + count
              duracion_speach = (tiempo_speach(texto) + 1)*1000;
              setTimeout(text_speach,tiempo_tts,texto);
              console.log("Dura speach " + duracion_speach);
              setTimeout(generar_audio_GLinea, tiempo_espera + 2000,vec_frecuencia[i], vec_tiempo[i],vec_canal);
              tiempo_tts =  tiempo_tts  + vec_tiempo[i].reduce((a, b) => a + b, 0)*1000 + duracion_speach;//2500;
              tiempo_espera = tiempo_tts; 
              count++;
            
          }

        }

        function sonido_continuo(){
            tocar_frecuencia(293.7,0,2);
            tocar_frecuencia(1000,1,2);
        }

        function generar_audio_GLinea(vector_frecuencia,vector_tiempo,vector_canales){

          //console.log("Tiempo total : " + tiempo_overlap)

          var contexto_audio = new (window.AudioContext || window.webkitAudioContext)();

            
          let t_inicial = 0;
          let t_final = 0;
          let ganancias = [ 0.1 , 0.45 , 0.9 , 1 , 0.9 , 0.45 , 0.1 ]; //Valor de Ganancia para 7 canales
          let canales = [ 1 , 1 , 1 , 1 , 3 , 3 , 3 ]; //Correspondencias de Canal

          // create Oscillator node
          const oscillator1 = contexto_audio.createOscillator();
          const oscillator2 = contexto_audio.createOscillator();
          const oscillator3 = contexto_audio.createOscillator();
          const oscillator4 = contexto_audio.createOscillator();

          oscillator1.type = 'sine';
          oscillator2.type = 'sine';
          oscillator3.type = 'sine';
          oscillator4.type = 'sine';

          //console.log("llegan frecuencias " + vector_frecuencia);
          let vec_frec1 = vector_frecuencia.map(x => x * 1);
          //console.log("primera frec: " + vec_frec1);
          let vec_frec2 = vector_frecuencia.map(x => x * 2);
          //console.log("segunda frec: " + vec_frec2);
          let vec_frec3 = vector_frecuencia.map(x => x * 3);
          //console.log("tercera frec: " + vec_frec3);
          let vec_frec4 = vector_frecuencia.map(x => x * 4);
          //console.log("cuarta frec: " + vec_frec4);

          //Evitar que comprobaciones en oscilador completo se desborden:
          for( var i = 0; i < vec_frec1.length; i++){
              if(vec_frec1[i] < 293.7){
                  vec_frec1[i] = 2;
              }
              if(vec_frec2[i] < 293.7){
                  vec_frec2[i] = 2;
              }
              if(vec_frec3[i] < 293.7){
                  vec_frec3[i] = 2;
              }
              if(vec_frec4[i] < 293.7){
                  vec_frec4[i] = 2;
              }
          }

          let vec_gan1 = ganancias.map( x => x * 1);
          let vec_gan2 = ganancias.map( x => x * 0.8);
          let vec_gan3 = ganancias.map( x => x * 0.4);
          let vec_gan4 = ganancias.map( x => x * 0.2);

          let tiemp_final = definir_oscilador_completo(contexto_audio,oscillator1,vec_frec1,t_final,t_inicial,vector_tiempo,vector_canales,canales,vec_gan1);
  
          if(document.getElementById("Timbre").value == "T2"){

              console.log("Entro a 2 timbres");

              definir_oscilador_completo(contexto_audio,oscillator2,vec_frec2,t_final,t_inicial,vector_tiempo,vector_canales,canales,vec_gan2);

              oscillator1.start(0);
              oscillator2.start(0);

              oscillator1.stop(tiemp_final);
              oscillator2.stop(tiemp_final);
          }

          else if(document.getElementById("Timbre").value == "T3"){

              console.log("Entro a 3 timbres");

              definir_oscilador_completo(contexto_audio,oscillator2,vec_frec2,t_final,t_inicial,vector_tiempo,vector_canales,canales,vec_gan2);
              definir_oscilador_completo(contexto_audio,oscillator3,vec_frec3,t_final,t_inicial,vector_tiempo,vector_canales,canales,vec_gan3);

              oscillator1.start(0);
              oscillator2.start(0);
              oscillator3.start(0);

              oscillator1.stop(tiemp_final);
              oscillator2.stop(tiemp_final);
              oscillator3.stop(tiemp_final);
          }
          else if(document.getElementById("Timbre").value == "T4")
          {
              console.log("Entro a 4 timbres");
              definir_oscilador_completo(contexto_audio,oscillator2,vec_frec2,t_final,t_inicial,vector_tiempo,vector_canales,canales,vec_gan2);
              definir_oscilador_completo(contexto_audio,oscillator3,vec_frec3,t_final,t_inicial,vector_tiempo,vector_canales,canales,vec_gan3);
              definir_oscilador_completo(contexto_audio,oscillator4,vec_frec4,t_final,t_inicial,vector_tiempo,vector_canales,canales,vec_gan4);

              oscillator1.start(0);
              oscillator2.start(0);
              oscillator3.start(0);
              oscillator4.start(0);

              oscillator1.stop(tiemp_final);
              oscillator2.stop(tiemp_final);
              oscillator3.stop(tiemp_final);
              oscillator4.stop(tiemp_final);

          } else{
          
              oscillator1.start(0);
              //console.log("acabo " + tiemp_final + vector_tiempo[vector_tiempo.length - 1] );
              oscillator1.stop(tiemp_final);
        
          }


        }

        function asignar_ganancia(tipo,canal,tiempo,val_gan,gana_izq,gana_cen,gana_der,t_overlap){

          if(tipo == 1){

              switch(true){
                case (canal == 1):
                  gana_izq.gain.setValueAtTime(val_gan,tiempo);
                  gana_cen.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  gana_der.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  /*
                  gana_cen.gain.setValueAtTime(0,tiempo + t_overlap);
                  gana_der.gain.setValueAtTime(0,tiempo + t_overlap);
                  */
                  //console.log("Entro con ganan " + val_gan);
                  break;

                case (canal == 2):
                  gana_cen.gain.setValueAtTime(val_gan,tiempo);
                  gana_izq.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  gana_der.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  //console.log("Entro con ganan " + val_gan);
                  break;
                case (canal==3):
                  gana_der.gain.setValueAtTime(val_gan,tiempo);
                  gana_cen.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  gana_izq.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  //console.log("Entro con ganan " + val_gan);
                  break;
               }
          } else{

              switch(true){
                case (canal == 1):
                  gana_izq.gain.linearRampToValueAtTime(val_gan,tiempo);
                  gana_cen.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  gana_der.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  //console.log("Entro con ganan " + val_gan);
                  break;
                case (canal == 2):
                  gana_cen.gain.linearRampToValueAtTime(val_gan,tiempo);
                  gana_izq.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  gana_der.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  //console.log("Entro con ganan " + val_gan);
                  break;
                case (canal==3):
                  gana_der.gain.linearRampToValueAtTime(val_gan,tiempo);
                  gana_cen.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  gana_izq.gain.linearRampToValueAtTime(0,tiempo + t_overlap);
                  //console.log("Entro con ganan " + val_gan);
                  break;
                }
          }
        }


        function definir_oscilador_completo(audio_ctx,oscillator,vector_frecuencia,t_final,t_inicial,vector_tiempo,vector_canales,canales,ganancias){
          //console.log("Entra con frecuencias : " + vector_frecuencia)

          var ganancia_izq = audio_ctx.createGain();  
          var ganancia_der = audio_ctx.createGain(); 
          var ganancia_cent = audio_ctx.createGain();
          var cont = 0;
          var cont_aux = 0; 

          var merger = audio_ctx.createChannelMerger(6);
          //merger.channelCount = 3;
          merger.channelInterpretation = "discrete";
          //merger.channelCountMode = "explicit";

          //Connect splitter' outputs to each Gain Nodes
          oscillator.connect(ganancia_izq);
          oscillator.connect(ganancia_der);
          oscillator.connect(ganancia_cent);
          
          // 2 cent, 3 subwoofer, 4 izq_surr, 5 der_surr
          ganancia_izq.connect(merger, 0, 0);
          ganancia_der.connect(merger, 0, 1);
          ganancia_cent.connect(merger, 0, 2);

          for(var i = 0; i < vector_frecuencia.length; i++){

              //Definicion para los demas casos, se acumula en caso 2 (suavizado):
              if(vector_frecuencia[i] != 2){

                  //Frecuencia inicial
                  if(i == 0 || cont_aux == 0){
                      oscillator.frequency.setValueAtTime(vector_frecuencia[i], t_inicial);
                  }
                  else{
                      t_final = t_final + vector_tiempo[cont];
                      oscillator.frequency.linearRampToValueAtTime(vector_frecuencia[i], t_final); // value in hertz
                      cont++;
                  }
                  cont_aux = 1;
              }
              else{
                t_final = t_final + vector_tiempo[cont]
                cont++;
              } 

                //t_inicial = t_final;
          }

          //Generar for para ganancias
          let count = 0;
          let tiempo = 0;
          let aux_baj_sub = 0;
          //var dur_div = []
          let segmento = 0;
          let bajando = 0;
          let subiendo = 0;
          let can_aux = [];
          let tiempo_aux = [];
          let frec_aux = [];
          //console.log("Tiempo :" + vector_tiempo);
          //console.log("Canales :" + vector_canales);
          //console.log("Frecuencias : " + vector_frecuencia);
          
          cont_aux = 0;

          for(var j = 0; j < can_aux.length; j++){
              
              can_aux[j] = 0;
              tiempo_aux[j] = 0;
              frec_aux[j] = 0

              if(frec_aux[j+1] == 2 && frec_aux[j] != 2){
                  tiempo_aux[j+1] = (vector_tiempo[j]) + (vector_tiempo[j+1]);
                  can_aux[j+1] = vector_canales[j];
                  frec_aux[j+1] = vector_frecuencia[j]; 
              }
              else if(frec_aux[j+1] == 2 && frec_aux[j] == 2){
                  //tiempo_aux[j+1] = tiempo_aux[j] + tiempo_aux[j+1];
                  //can_aux[j+1] = can_aux[j];
              }
              else if(frec_aux[j+1] != 2 && frec_aux[j] == 2){
                  //tiempo_aux[j+1] = tiempo_aux[j] + tiempo_aux[j+1];
              }
              else if(frec_aux[j+1] != 2 && frec_aux[j] != 2){

                //console.log("Entra con canal:  " + can_aux[j] + " - a tiempo : " + tiempo_aux[j]);

              if( tiempo == 0 || cont_aux == 0){
                  
                  asignar_ganancia(1,canales[can_aux[j]-1],0,ganancias[can_aux[j]-1],ganancia_izq,ganancia_cent,ganancia_der,tiempo*0.02);
                  //tiempo = tiempo + tiempo_canales[j];
                  //console.log("inicio: " + "  j -> " + j +" canal -> " + canales[vector_canales[j]-1] + " gain ->" + ganancias[vector_canales[j]-1] + " tiempo ->" + tiempo);
                 
              } 
              
              if(j == can_aux.length - 1 ){

                //console.log("Final Conseguido!");

              } else if( can_aux[j] == can_aux[j+1] ){
                  asignar_ganancia(1,canales[can_aux[j]-1],tiempo,ganancias[can_aux[j]-1],ganancia_izq,ganancia_cent,ganancia_der,(vector_tiempo[j])*0.1);
                  tiempo = tiempo + tiempo_aux[j];

                  //console.log("igual: " + "  j -> " + j +" canal -> " + canales[vector_canales[j]-1] + " gain ->" + ganancias[vector_canales[j]-1]  + " tiempo ->" + tiempo);

              } else if( can_aux[j] > can_aux[j+1]){

                  //asignar_ganancia(1,canales[vector_canales[j]-1],tiempo,ganancias[vector_canales[j]-1],ganancia_izq,ganancia_cent,ganancia_der,tiempo*0.1);

                  aux_baj_sub = can_aux[j] - can_aux[j+1];
                  segmento = tiempo_aux[j]/(aux_baj_sub);
                  bajando  = 2;

                  for(var k = 0; k < aux_baj_sub; k++){
                      tiempo = tiempo + segmento;
                      asignar_ganancia(2,canales[can_aux[j]-bajando],tiempo,ganancias[can_aux[j]-bajando],ganancia_izq,ganancia_cent,ganancia_der,vector_tiempo[j]*0.1);
                      //console.log("DEscifra subida:  canal -> " + canales[vector_canales[j] -bajando] + " ganancias -> " + ganancias[vector_canales[j]-bajando] + " k ->" + k);
                      //console.log("Descifrando bajada:  -> " + vector_canales[j]+bajando);
                      bajando++;
                  }

                  bajando = 2;

                  //console.log("bajada: " + "  j -> " + j +" canal -> " + canales[vector_canales[j]-bajando] + " gain ->" + ganancias[vector_canales[j]-bajando]  + " tiempo -> " + tiempo );

              } else if ( can_aux[j] < can_aux[j+1] ){

                 // asignar_ganancia(1,canales[vector_canales[j]-bajando],tiempo,ganancias[vector_canales[j]-1],ganancia_izq,ganancia_cent,ganancia_der,tiempo*0.05);
                  aux_baj_sub = can_aux[j+1] - can_aux[j]
                  segmento = tiempo_aux[j]/(aux_baj_sub);
                  subiendo = 0;

                  for(var k = 0; k < aux_baj_sub; k++){
                      tiempo = tiempo + segmento;
                      asignar_ganancia(2,canales[can_aux[j] + subiendo],tiempo,ganancias[can_aux[j] + subiendo],ganancia_izq,ganancia_cent,ganancia_der,vector_tiempo[j]*0.1);
                      
                      //console.log("DEscifra subida:  canal -> " + canales[vector_canales[j] + subiendo] + " ganancias -> " + ganancias[vector_canales[j]+ subiendo] + " k ->" + k);
                      subiendo++;

                  }
                  subiendo = 0;

                  //console.log("subida: " + "  j -> " + j +" canal -> " + canales[vector_canales[j]] + " gain ->" + ganancias[vector_canales[j]]  + " tiempo -> " + tiempo);

              }


            
            }
            cont_aux = 1;

          }
          
          //oscillator.connect(audioCtx.destination);
          merger.connect(audio_ctx.destination);
          
          return t_final;


        }


        function audio_espacial(){

          const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

          // create Oscillator node
          const oscillator = audioCtx.createOscillator();

          oscillator.type = 'square';
          // 0 MONO
          // LFE subwoofer
          var ganancia_izq = audioCtx.createGain();  
          var ganancia_der = audioCtx.createGain(); 
          var ganancia_cent = audioCtx.createGain();
          var ganancia_izq_surr = audioCtx.createGain(); 
          var ganancia_der_surr = audioCtx.createGain(); 

          var merger = audioCtx.createChannelMerger(6);
          //merger.channelCount = 3;
          merger.channelInterpretation = "discrete";
          //merger.channelCountMode = "explicit";

          //Connect splitter' outputs to each Gain Nodes
          oscillator.connect(ganancia_izq);
          oscillator.connect(ganancia_der);
          oscillator.connect(ganancia_cent);
          oscillator.connect(ganancia_izq);
          oscillator.connect(ganancia_izq_surr);
          
          // 2 cent, 3 subwoofer, 4 izq_surr, 5 der_surr
          ganancia_izq.connect(merger, 0, 0);
          ganancia_der.connect(merger, 0, 1);
          ganancia_cent.connect(merger, 0, 2);
          ganancia_izq_surr.connect(merger, 0, 4);  
          ganancia_der_surr.connect(merger, 0, 5);
        
          oscillator.frequency.setValueAtTime(300, 0);
          //oscillator.frequency.setValueAtTime(1000, 2);

          ganancia_izq_surr.gain.setValueAtTime(0,0);
          ganancia_izq.gain.setValueAtTime(0,0);
          ganancia_cent.gain.setValueAtTime(0,0);
          ganancia_der.gain.setValueAtTime(0,0);
          ganancia_der_surr.gain.setValueAtTime(1,0);

          ganancia_izq_surr.gain.setValueAtTime(0,1);
          ganancia_izq.gain.setValueAtTime(0,1);
          ganancia_cent.gain.setValueAtTime(0,1);
          ganancia_der.gain.setValueAtTime(1,1);
          ganancia_der_surr.gain.setValueAtTime(0,1);

          ganancia_izq.gain.setValueAtTime(0,2);
          ganancia_der.gain.setValueAtTime(0,2);
          ganancia_cent.gain.setValueAtTime(1,2);
          ganancia_der.gain.setValueAtTime(0,2);
          ganancia_der_surr.gain.setValueAtTime(0,2);
          
          merger.connect(audioCtx.destination);

          //Connect Left and Right Nodes to the output  
          //Assuming stereo as initial status

          //splitter.connect(audioCtx.destination);
          oscillator.start(0);
          oscillator.stop(3);


        }

        function my_dtm(){
            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var channels = 2;
            // Create an empty two second stereo buffer at the
            // sample rate of the AudioContext
            var frameCount = audioCtx.sampleRate * 2.0;

            var myArrayBuffer = audioCtx.createBuffer(channels, frameCount, audioCtx.sampleRate);
            let num_2 = 0.05;

            for (var channel = 0; channel < channels; channel++) {
            // This gives us the actual ArrayBuffer that contains the data
            var nowBuffering = myArrayBuffer.getChannelData(channel);
               for (var i = 0; i < frameCount; i++) {
                  // Math.random() is in [0; 1.0]
                  // audio needs to be in [-1.0; 1.0]
                  nowBuffering[i] = 1;
                }
            }

            // Get an AudioBufferSourceNode.
           // This is the AudioNode to use when we want to play an AudioBuffer
           var source = audioCtx.createBufferSource();
          // set the buffer in the AudioBufferSourceNode
          source.buffer = myArrayBuffer;
          // connect the AudioBufferSourceNode to the
          // destination so we can hear the sound
          source.connect(audioCtx.destination);
          // start the source playing
          source.start();
        }
        
        /*
        function probando_audioBuffer(){
            var context = new (window.AudioContext || window.webkitAudioContext)();

            //Sonido de 1/2 (0,5) segundos
            var myArrayBuffer = context.createBuffer(2,22050, 44100);
            var nowBuffering = myArrayBuffer.getChannelData(1);
            nowBuffering[1] = [100,200,300];

        }
        */


        function ejecutar_despues(tiempo_muerto){
            return new Promise(resolve => setTimeout(resolve, tiempo_muerto));
        }

        function detener_audio(){

            /*
            if (contexto_audio.state === 'running') {
                contexto_audio.suspend();
            }
            */
            return;
        }

        function text_speach(mensaje){
            //var mensaje = document.getElementById("tts").value
            // This overrides the text "Hello World" and is uttered instead
            //utterance.text = "My name is Glad.";
            //Speak Rate 1 por defecto, correspondiente a 180 a 220 palabras por minuto
            utterance.text = mensaje;
            synthesis.speak(utterance);

        }

        function tiempo_speach(mensaje){
            //Speak Rate 1 por defecto, correspondiente a 150 a 220 palabras por minuto [wpm] 
            let wps = 100 / 60;
            return mensaje.split(" ").length/wps;

        }

    </script>
  </body>
</html>
